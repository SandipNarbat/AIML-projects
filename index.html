<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Realtime Queue Monitor</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
</head>

<body>

    <h2>ðŸ“Š Realtime Queue Buildup Monitor</h2>
    <div class="table-container">
        <table id="queueTable">
            <thead>
                <tr id="headerRow">
                    <th>Queue</th>
                    <th>M</th>
                    <th>S1</th>
                    <th>s2</th>
                    <th>s3</th>
                    <th>s4</th>
                    <th>s5</th>
                    <th>s6</th>
                    <th>s7</th>
                    <th>s8</th>
                    <th>s9</th>
                    <th>s10</th>
                    <th>s11</th>
                    <th>s12</th>
                    <th>s13</th>
                    <th>s14</th>

                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        const tableBody = document.getElementById("tableBody");
        const headerRow = document.getElementById("headerRow");

        // In-memory state
        const state = {};

        // --------------------------------------------------
        // Build table from SNAPSHOT
        // --------------------------------------------------
        function renderSnapshot(snapshot) {
            tableBody.innerHTML = "";
            // headerRow.innerHTML = "<th>Queue</th>";

            const queues = Object.keys(snapshot);
            if (queues.length === 0) return;

            const metricCount = snapshot[queues[0]].length;

            // Build header
            // for (let i = 0; i < metricCount; i++) {
            //     const th = document.createElement("th");
            //     th.textContent = `M${i + 1}`;
            //     headerRow.appendChild(th);
            // }

            // Build rows
            queues.forEach(queue => {
                state[queue] = snapshot[queue];

                const tr = document.createElement("tr");
                tr.id = `row-${queue}`;

                // Queue name
                const th = document.createElement("th");
                th.textContent = queue;
                tr.appendChild(th);

                snapshot[queue].forEach((val, i) => {
                    const td = document.createElement("td");
                    td.id = `cell-${queue}-${i}`;

                    // ðŸ”¹ CREATE SPAN
                    const span = document.createElement("span");
                    span.className = "cell-value";
                    span.id = `cell-value-${queue}-${i}`;

                    applyCellStyle(span, val); // style the span, not td

                    td.appendChild(span);
                    tr.appendChild(td);
                });

                tableBody.appendChild(tr);
            });
        }


        // --------------------------------------------------
        // Apply delta updates
        // --------------------------------------------------
        function applyDelta(delta) {
            const queue = delta.queue;
            if (!state[queue]) return;

            delta.changes.forEach(change => {
                const { index, new: newVal } = change;

                state[queue][index] = newVal;

                const span = document.getElementById(
                    `cell-value-${queue}-${index}`
                );
                if (!span) return;

                applyCellStyle(span, newVal);

                span.classList.add("updated");
                setTimeout(() => span.classList.remove("updated"), 600);
            });
        }


        // --------------------------------------------------
        // Styling logic
        // --------------------------------------------------
        function applyCellStyle(el, value) {
            el.className = "cell-value"; // reset

            if (value === 0) {
                el.textContent = "0";
                el.classList.add("ok");
            }
            else if (value <= -1) {
                el.innerHTML = `
                    <span class="material-icons">thumb_down</span>
                    `;
                el.classList.add("warning");
            }
            else {
                el.textContent = value;
                el.classList.add("critical");
            }
        }


        // --------------------------------------------------
        // SSE Connection
        // --------------------------------------------------
        const es = new EventSource("http://localhost:8000/events");

        es.addEventListener("snapshot", e => {
            const snapshot = JSON.parse(e.data);
            console.log("Snapshot received", snapshot);
            renderSnapshot(snapshot);
        });

        es.addEventListener("delta", e => {
            const delta = JSON.parse(e.data);
            console.log("Delta received", delta);
            applyDelta(delta);
        });

        es.onerror = () => {
            console.error("SSE connection lost");
        };
    </script>

</body>

</html>